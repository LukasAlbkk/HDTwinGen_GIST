{"messages": [{"role": "system", "content": "\nObjective: Write fully functional PyTorch code that fills the provided class skeleton ONLY, to create an effective differential-equation-like simulator for the specified environment. No placeholders, no extra files.\n\nNon-negotiable rules:\n- Do NOT change the class name, method names, argument order, or return types.\n- Fill ONLY the TODOs INSIDE the skeleton. You may define submodules and small private helper methods INSIDE the class, but must not add new public methods or change signatures.\n- Code must run with batch size = 1 (and any B>=1). Therefore:\n  * Do NOT use BatchNorm of any kind. If you need normalization, use LayerNorm.\n- Use only PyTorch standard library (torch, torch.nn, torch.nn.functional) and typing.Tuple.\n- All tensors are float32; assume inputs come as shape [B,1]. Concatenate on last dim.\n- Enforce numerical stability: clamp outputs to physiologically plausible ranges.\n- Treatment/control inputs MUST influence the dynamics as required by the environment.\n- Prefer monotone-increasing or monotone-decreasing effects when medically sensible (see env description).\n- Use LeakyReLU or ELU (avoid dead ReLU), Dropout in {0.1\u20130.3}, and avoid weight explosions.\n\nQuality bar:\n- Prefer a hybrid design: simple mechanistic prior + residual MLP correction.\n- If using gates, ensure positivity via Softplus.\n- No randomness, no training loops here, just the model class.\n\nSelf-checks inside forward:\n- Assert the concatenated input has last-dim size equal to the specified count.\n- Never return NaN/Inf; clamp derivatives.\n\nIndent code with tabs. Return the complete class code body."}, {"role": "user", "content": "\nYou will get a system description to code a differential equation simulator for.\n\nSystem Description:```\nMulti-Feature Treatment Response Model for GIST (CBIO Dataset)\n\nGOAL:\nImplement a neural ODE-like differential model that outputs 4 derivatives for the 4 STATE variables, using 7 STATIC features for personalization and 1 CONTROL input (treatment_duration). Code must ONLY fill the provided class skeleton.\n\nINPUTS (order is FIXED; each is a [B,1] tensor):\n1. tumor_size (STATE)               [1.0\u201330.0] cm\n2. msi_score (STATE)                [0.0\u201310.0]\n3. tmb_nonsynonymous (STATE)        [0.0\u20133.0]\n4. mitotic_rate (STATE)             [0.0\u2013100.0]\n5. age_at_diagnosis (STATIC)        [20\u201390] years\n6. stage_encoded (STATIC)           {0=Localized,1=Metastatic}\n7. treatment_encoded (STATIC)       {0=IMATINIB,1=SUNITINIB,2=REGORAFENIB,3=TRIAL,4=OTHER}\n8. has_kit_mutation (STATIC)        {0/1}\n9. tumor_purity (STATIC)            [0\u2013100] %\n10. site_small_intestine (STATIC)   {0/1}\n11. site_stomach (STATIC)           {0/1}\n12. treatment_duration (CONTROL)    [0\u20132000] days (cumulative)\n\nOUTPUT (order is FIXED; each [B,1]):\nreturn (d_tumor_size__dt, d_msi_score__dt, d_tmb_nonsynonymous__dt, d_mitotic_rate__dt)\n\nHARD CONSTRAINTS (must implement):\n1) DO NOT use BatchNorm. If normalizing hidden reps, use LayerNorm.\n2) Treatment MUST matter and be **monotone suppressive** for tumor_size:\n   Implement a non-negative gate \u03b3(x) = Softplus(MLP(all 12 inputs)) and apply:\n   d_tumor_size__dt = d_tumor_size__dt - \u03b3 * treatment_duration\n   This ensures higher treatment_duration makes growth less positive (or more negative).\n3) Stability: clamp derivatives to plausible ranges, e.g.:\n   d_tumor_size__dt \u2208 [-5, 5], d_msi_score__dt \u2208 [-1, 1], d_tmb_nonsynonymous__dt \u2208 [-0.05, 0.05], d_mitotic_rate__dt \u2208 [-10, 10].\n4) Activation & regularization: use LeakyReLU (or ELU), Dropout in [0.1,0.3]. Avoid exploding weights.\n5) Personalization: allow STATIC features to modulate the dynamics (e.g., via learned gates/embeddings or by concatenation into the MLP).\n6) Assertions: inside forward, assert concatenated input has last-dim = 12. Never return NaN/Inf.\n\nRECOMMENDED BLUEPRINT (simple and effective):\n- Concatenate ALL 12 inputs into x (dim=-1).\n- MLP block: Linear(12\u2192256) \u2192 LayerNorm(256) \u2192 LeakyReLU \u2192 Dropout(0.2) \u2192 Linear(256\u2192256) \u2192 LayerNorm(256) \u2192 LeakyReLU \u2192 Dropout(0.2) \u2192 Linear(256\u219264) \u2192 LeakyReLU \u2192 Linear(64\u21924).\n- Split outputs into (d_tumor, d_msi, d_tmb, d_mitotic).\n- Monotone treatment gate: \u03b3 = Softplus(Linear(12\u219264)\u2192LeakyReLU\u2192Linear(64\u21921)).\n- Apply d_tumor \u2190 d_tumor - \u03b3 * treatment_duration.\n- Clamp all four derivatives to the given ranges.\n- Return them in the exact required order.\n\nMEDICAL PRIOR (lightweight; do NOT overconstrain):\n- Tumor growth tends to slow as mass increases (implicit via MLP + clamp).\n- Longer effective treatment typically reduces net growth \u2192 enforced by the monotone gate.\n- MSI/TMB/mitotic_rate change slowly vs tumor_size; keep derivative magnitudes small (use clamps).\n\nEVALUATION GUARD (implement as inline sanity checks / comments):\n- For a random batch, compute outputs twice: with treatment_duration=0 vs +1000. Ensure d_tumor_size__dt with +1000 is <= the value with 0 (monotone).\n- Ensure shapes: all inputs [B,1], concatenation \u2192 last-dim=12, outputs split in 4\u00d7[B,1].\n\nVARIABLE DESCRIPTIONS (for context):\nSTATE VARIABLES (require derivatives):\n* tumor_size: Primary outcome measure, cm (longest diameter)\n* msi_score: Microsatellite instability (genomic biomarker)\n* tmb_nonsynonymous: Tumor mutational burden (mutation count)\n* mitotic_rate: Proliferation rate (mitoses per 50 HPF)\n\nSTATIC FEATURES (NO derivatives - patient characteristics):\n* age_at_diagnosis: Patient age in years\n* stage_encoded: 0=Localized, 1=Metastatic\n* treatment_encoded: 0=IMATINIB (1st line), 1=SUNITINIB (2nd line), 2=REGORAFENIB (3rd line), 3=TRIAL, 4=OTHER\n* has_kit_mutation: 0=No, 1=Yes (KIT+ tumors respond better to IMATINIB)\n* tumor_purity: Percentage of tumor cells (affects biomarker reliability)\n* site_small_intestine: 1=Small Intestine, 0=Other\n* site_stomach: 1=Stomach, 0=Other\n\nCONTROL INPUT:\n* treatment_duration: Cumulative days of treatment (MUST suppress tumor growth monotonically)\n", "function_call": {"name": "complete_StateDifferential_code"}}], "simulator_code_dict": {}, "steps": [], "step": null, "meta_messages": [], "message_hash": "ad554ead363aa1b68fbdea16bde02debb03f0b92f46b5e0c17a5501e04a83c63"}