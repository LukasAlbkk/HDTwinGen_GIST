# Best model generated by HDTwinGen NSDT
# Environment: Dataset-CBIO
# Seed: 43
# Test MSE: 26.990578
# Val MSE: 31.309700

import torch
import torch.nn as nn
from typing import Tuple

import torch
import torch.nn as nn
import torch.nn.functional as F
from typing import Tuple

class StateDifferential(nn.Module):
	def __init__(self):
		super(StateDifferential, self).__init__()
		self.mlp = nn.Sequential(
			nn.Linear(12, 256),
			nn.LayerNorm(256),
			nn.LeakyReLU(0.1),
			nn.Dropout(0.2),
			nn.Linear(256, 256),
			nn.LayerNorm(256),
			nn.LeakyReLU(0.1),
			nn.Dropout(0.2),
			nn.Linear(256, 64),
			nn.LeakyReLU(0.1),
			nn.Linear(64, 4)
		)
		self.treatment_gate = nn.Sequential(
			nn.Linear(12, 64),
			nn.LeakyReLU(0.1),
			nn.Linear(64, 1)
		)

	def forward(self, tumor_size: torch.Tensor, msi_score: torch.Tensor, tmb_nonsynonymous: torch.Tensor, mitotic_rate: torch.Tensor,
			age_at_diagnosis: torch.Tensor, stage_encoded: torch.Tensor, treatment_encoded: torch.Tensor,
			has_kit_mutation: torch.Tensor, tumor_purity: torch.Tensor, site_small_intestine: torch.Tensor,
			site_stomach: torch.Tensor, treatment_duration: torch.Tensor) -> Tuple[torch.Tensor, torch.Tensor, torch.Tensor, torch.Tensor]:
		# Concatenate inputs
		x = torch.cat((tumor_size, msi_score, tmb_nonsynonymous, mitotic_rate,
			age_at_diagnosis, stage_encoded, treatment_encoded,
			has_kit_mutation, tumor_purity, site_small_intestine, site_stomach, treatment_duration), dim=-1)
		assert x.shape[-1] == 12, "Input must have last dimension of size 12"

		# Compute derivatives
		dynamics = self.mlp(x)
		d_tumor_size__dt, d_msi_score__dt, d_tmb_nonsynonymous__dt, d_mitotic_rate__dt = dynamics.split(1, dim=-1)

		# Compute treatment gate
		gamma = F.softplus(self.treatment_gate(x))

		# Apply treatment effect
		d_tumor_size__dt = d_tumor_size__dt - gamma * treatment_duration

		# Clamp outputs to physiological ranges
		d_tumor_size__dt = torch.clamp(d_tumor_size__dt, -5, 5)
		d_msi_score__dt = torch.clamp(d_msi_score__dt, -1, 1)
		d_tmb_nonsynonymous__dt = torch.clamp(d_tmb_nonsynonymous__dt, -0.05, 0.05)
		d_mitotic_rate__dt = torch.clamp(d_mitotic_rate__dt, -10, 10)

		# Sanity checks
		assert not torch.any(torch.isnan(dynamics)), "Output contains NaN"
		assert not torch.any(torch.isinf(dynamics)), "Output contains Inf"

		return d_tumor_size__dt, d_msi_score__dt, d_tmb_nonsynonymous__dt, d_mitotic_rate__dt

# Optimized Parameters:
# {}
